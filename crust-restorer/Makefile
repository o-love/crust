.PHONY: all clean check

# Build artifacts directory
TARGET_DIR = target
RELEASE_DIR = ../target/release

# Build outputs
STATICLIB = $(RELEASE_DIR)/libcrust_restorer.a
RESTORER_ELF = $(TARGET_DIR)/restorer.elf
RESTORER_BIN = $(TARGET_DIR)/restorer_blob.bin
RESTORER_RS = $(TARGET_DIR)/restorer_blob.rs

# Size limit (200KB)
MAX_BLOB_SIZE = 204800

all: $(RESTORER_RS)

$(RESTORER_RS): src/lib.rs Cargo.toml ../crust-syscall/src/*.rs
	@echo "=== Building crust-restorer blob ==="
	@cargo build --release
	@if [ ! -f "$(STATICLIB)" ]; then \
		echo "ERROR: Library not found at $(STATICLIB)"; \
		exit 1; \
	fi
	@echo "[OK] Built staticlib"
	@echo ""
	@echo "=== Linking into PIE executable ==="
	@mkdir -p $(TARGET_DIR)
	@ld -pie \
		--eh-frame-hdr \
		-z noexecstack \
		-z relro \
		-z now \
		--gc-sections \
		-e _start \
		-o $(RESTORER_ELF) \
		--whole-archive $(STATICLIB) --no-whole-archive \
		--strip-all
	@echo "[OK] Linked PIE executable: $(RESTORER_ELF)"
	@echo ""
	@echo "=== Checking for relocations ==="
	@if readelf -r $(RESTORER_ELF) | grep -E "\.text" | grep -q "R_X86_64"; then \
		echo "[WARNING] Found relocations in .text"; \
		readelf -r $(RESTORER_ELF) | grep -E "\.text" | head -20; \
	else \
		echo "[OK] Zero relocations in .text!"; \
	fi
	@echo ""
	@echo "=== Extracting .text and .rodata sections ==="
	@objcopy -O binary \
		--only-section=.text \
		--only-section=.rodata \
		$(RESTORER_ELF) \
		$(RESTORER_BIN)
	@BLOB_SIZE=$$(stat -c%s $(RESTORER_BIN)); \
	echo "Blob size: $$BLOB_SIZE bytes"; \
	if [ $$BLOB_SIZE -gt $(MAX_BLOB_SIZE) ]; then \
		echo "[WARNING] Blob larger than 200KB"; \
	else \
		echo "[OK] Blob size acceptable"; \
	fi
	@echo ""
	@echo "=== Generating Rust byte array ==="
	@echo '//! Autogenerated restorer blob' > $(RESTORER_RS)
	@echo '//!' >> $(RESTORER_RS)
	@echo '//! Generated by crust-restorer/Makefile' >> $(RESTORER_RS)
	@echo '//! DO NOT EDIT MANUALLY' >> $(RESTORER_RS)
	@echo '' >> $(RESTORER_RS)
	@echo 'pub const RESTORER_BLOB: &[u8] = &[' >> $(RESTORER_RS)
	@xxd -i < $(RESTORER_BIN) >> $(RESTORER_RS)
	@echo '];' >> $(RESTORER_RS)
	@echo '' >> $(RESTORER_RS)
	@echo 'pub const RESTORER_SIZE: usize = RESTORER_BLOB.len();' >> $(RESTORER_RS)
	@echo '' >> $(RESTORER_RS)
	@ENTRY_POINT=$$(readelf -h $(RESTORER_ELF) | grep 'Entry point address' | awk '{print $$NF}'); \
	TEXT_START=$$(readelf -S $(RESTORER_ELF) | grep '\.text' | head -1 | awk '{for(i=1;i<=NF;i++)if($$i=="PROGBITS")print "0x"$$(i+1)}'); \
	ENTRY_OFFSET=$$(($$ENTRY_POINT - $$TEXT_START)); \
	echo "pub const RESTORER_ENTRY_OFFSET: usize = $$ENTRY_OFFSET;" >> $(RESTORER_RS)
	@echo "[OK] Generated $(RESTORER_RS)"

clean:
	@rm -rf $(TARGET_DIR)
	@echo "Cleaned crust-restorer artifacts from $(TARGET_DIR)"

check: $(RESTORER_ELF)
	@echo "=== Restorer validation ==="
	@echo "ELF file: $(RESTORER_ELF)"
	@readelf -h $(RESTORER_ELF) | grep -E "(Type|Entry)"
	@echo ""
	@echo "Blob size: $$(stat -c%s $(RESTORER_BIN)) bytes"
	@echo ""
	@echo "Relocations in .text:"
	@readelf -r $(RESTORER_ELF) | grep -E "\.text" || echo "  (none)"
